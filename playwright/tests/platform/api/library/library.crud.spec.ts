import { expect, test } from '@playwright/test'
import {
  createLibrary,
  queryLibraryContent
} from '../../../../utils/platform/library'
import { expectedResponsePostLibrary } from '../../../../data/api/library'
import { wait } from '../../../../utils/platform/utils'
import {
  createLibraryContent,
  deleteLibraryContent
} from '../../../../utils/platform/library-content'
test.describe('Library CRUD Test', () => {
  const TIMESTAMP = Date.now()
  const DISPLAY_NAME = `Test Library ${TIMESTAMP}`
  let library: LibrarySummary

  test('Create Library success', async ({ baseURL, request }) => {
    const postResp = await createLibrary(request, {
      displayName: DISPLAY_NAME
    })
    expect(postResp.status()).toBe(201)
    library = await postResp.json()
    // ensure id field is present
    expect(library.id).toBeTruthy()
    const expectedPostResp = await expectedResponsePostLibrary(
      library.id,
      library.displayName,
      baseURL
    )
    // we want to avoid checking the id field since it's autogenerated so we use toMatchObject
    expect(library).toMatchObject(expectedPostResp)
  })
  test('Get documents for a library, when library doesnt exist', async ({
    request
  }) => {
    const documentsResponse = await queryLibraryContent(request, 'NOT_FOUND')
    expect(documentsResponse.status()).toBe(404)
  })
  test.describe('tests need library created before of its execution', () => {
    let libraryData
    test.beforeEach(async ({ request }) => {
      const postResp = await createLibrary(request, {
        displayName: DISPLAY_NAME + ' library created before'
      })
      expect(postResp.status()).toBe(201)
      libraryData = await postResp.json()
    })
    test('Get documents for a library (empty)', async ({ request }) => {
      const documentsResponse = await queryLibraryContent(
        request,
        libraryData.id
      )
      expect(documentsResponse.status()).toBe(200)
      const documents = await documentsResponse.json()
      expect(documents['content'].length).toEqual(0)
    })

    test.describe('tests need Associate Library w/document created before its execution', () => {
      let document
      test.beforeEach(async ({ request }) => {
        const data: LibraryContentCommand = {
          title: 'Test title ' + TIMESTAMP,
          description: 'Test description ' + TIMESTAMP,
          type: 'ARTICLE',
          parentId: null,
          remoteContentSource: 'GOOGLE_DRIVE',
          remoteContentId: '' + TIMESTAMP,
          libraryId: libraryData.id
        }

        const associateDocument = await createLibraryContent(request, data)
        expect(associateDocument.status()).toBe(201)
        document = await associateDocument.json()
        await wait(2000)
      })

      test.afterEach(async ({ request }) => {
        await deleteLibraryContent(request, document.id)
      })
      test('Get documents for a library (success) not q parameter', async ({
        request
      }) => {
        const documentsResponse = await queryLibraryContent(
          request,
          libraryData.id
        )

        expect(documentsResponse.status()).toBe(200)
        const documents = await documentsResponse.json()
        expect(documents['content'].length).toEqual(1)
        expect(documents['content'][0].id).toEqual(document.id)
      })
      test('Get documents for a library (success) with q parameter', async ({
        request
      }) => {
        const documentsResponse = await queryLibraryContent(
          request,
          libraryData.id,
          { q: TIMESTAMP + '' }
        )

        expect(documentsResponse.status()).toBe(200)
        const documents = await documentsResponse.json()
        expect(documents['content'].length).toEqual(1)
        expect(documents['content'][0].id).toEqual(document.id)
      })
      test('Get documents for a library with q parameter, not match', async ({
        request
      }) => {
        const documentsResponse = await queryLibraryContent(
          request,
          libraryData.id,
          { q: 'blah' }
        )

        expect(documentsResponse.status()).toBe(200)
        const documents = await documentsResponse.json()
        expect(documents['content'].length).toEqual(0)
      })
      test('Get documents for a library filter by type', async ({
        request
      }) => {
        const documentsResponse = await queryLibraryContent(
          request,
          libraryData.id,
          { q: TIMESTAMP + '', filters: [['type', 'ARTICLE']] }
        )

        expect(documentsResponse.status()).toBe(200)
        const documents = await documentsResponse.json()
        expect(documents['content'].length).toEqual(1)
        expect(documents['content'][0].id).toEqual(document.id)
      })
    })
  })
})
